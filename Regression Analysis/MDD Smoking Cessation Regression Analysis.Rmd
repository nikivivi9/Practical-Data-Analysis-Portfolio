---
title: "Influence of Baseline Characteristics on Smoking Cessation in MDD: A Study of Behavioral and Pharmacological Treatment Effects"
author: Yingxi Kong
output:
  pdf_document
bibliography: references.bib
csl: apa-numeric-superscript.csl
---

# Abstract

**Background:** People with Major Depressive Disorder (MDD) are more likely to engage in tobacco use. However, most smoking cessation clinical trials had excluded this group from the enrollment, limiting available information to support smoking cessation for this group. This study, collaborating with Dr. George Papandonatos, aims to evaluates behavioral and pharmacological treatment for smoking cessation in adults with MDD to identify baseline characteristics that may moderate the behavioral treatment or predict smoking cessation outcome.

**Methods:** In a 2 × 2 factorial, randomized, placebo-controlled trial, 300 adult smokers with current or past MDD were randomly assigned to either Behavioral Activation for Smoking Cessation (BASC) or standard treatment (ST), combined with either varenicline or placebo. Participants' demographic characteristics, smoking behavior, mental health measurement, and the abstinence outcome at the week 27 follow-up were collected. Lasso regression was employed to identify significant baseline characteristics and potential interaction effects with treatment, controlling for both behavioral and pharmacotherapy assignments. In addition, bootstrapping is applied to provide a more robust and stable analysis.

**Results:** Findings suggest that as predictors, controlling for treatment groups and other factors, having higher nicotine metabolism ratio and identifying as Non-Hispanic White were associated with higher likelihood of abstinence, while higher nicotine dependence score and current MDD experience were associated with lower odds of abstinence. Moreover, income, menthol cigarette users indicators, and nicotine dependece score serve as moderators of the behavioral treatment effect on the end-of-treatment (EOT) abstinence. 

**Conclusion:** This study provides insights into how smoking cessation treatment outcomes among adults with MDD interact with baseline characteristics, identifying demographic factors, nicotine dependence, and MDD status as key predictors and moderators. However, variation in treatment adherence and several underrepresented groups could have influenced the estimate of treatment effect. Further research should explore strategies to improve engagement and broaden data collection to achieve better representation of these groups, enhancing the accuracy and generalizability of the findings. Further researches focusing on relaxed lasso or L0 + L2 penalty with more bootstrap iterations are also recommended.

# Introduction

Major Depressive Disorder (MDD) has been one of the most prevalent mental health disorders in the world, with rates that have continued to rise, particularly during the COVID-19 pandemic[@santomauro2021global]. Individuals with MDD are not only at risk for a range of adverse health outcomes but are also more likely to engage in harmful health behaviors, including tobacco use. The rate of smoking among individuals with MDD is 2–3 times higher than in the general population [@weinberger2020trends]. However, most smoking cessation clinical trials have excluded this important group from the trial enrollment [@hitsman2013past], thereby limiting available information and recommendations to support smoking cessation for this group.

A recent randomized, placebo-controlled trial led by Dr. George Papandonatos evaluated the efficacy and safety of combining behavioral and pharmacological treatment for smoking cessation among individuals with current or past MDD. The study involved 300 participants and employed a 2 × 2 factorial design to compare Behavioral Activation for Smoking Cessation (BASC) with standard treatment (ST), and varenicline with placebo. BASC, a behavioral intervention designed to enhance engagement in rewarding activities and reduce avoidance behavior, was paired with varenicline, a pharmacotherapy shown to reduce cravings and mitigate nicotine's rewarding effects. The results indicated that while varenicline significantly improved abstinence rates compared to placebo, BASC did not outperform ST, suggesting that while pharmacotherapy may provide substantial benefits for smokers with MDD, the behavioral component of cessation treatment may require further refinement.

Collaborating with Dr. George Papandonatos, this study aims to investigate the role of baseline characteristics as potential moderators of the effectiveness of behavioral treatment on end-of-treatment (EOT) abstinence outcomes. Furthermore, we aim to assess these baseline characteristics as predictors of abstinence, while controlling for both behavioral treatment and pharmacotherapy. By identifying factors that may influence the efficacy of cessation interventions, this analysis would contribute to inform targeted treatment strategies to enhance smoking cessation outcomes among individuals with MDD.     

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

# load necessary packages
library(tidyverse)
library(mice)
library(gt)
library(gtsummary)
library(kableExtra)
library(RColorBrewer)
library(scico)
library(caret)
library(glmnet)
library(pROC)
library(predtools)
library(gridExtra)
library(ggpubr)
library(patchwork)
library(e1071)
library(corrplot)
library(L0Learn)
library(MASS)
library(magick)
library(grid)
library(gridExtra)
```

```{r}
# set working directory
# Windows
setwd("C:/Users/yingx/OneDrive/Desktop/Fall 2024/PHP 2550/Data/")

# Mac
# setwd("~/Desktop/Fall 2024/PHP 2550/Data/")

# read in data
data <- read.csv("project2.csv")
```


# Methods

Our sample population consists of 300 adult smokers with or previously with MDD, without psychotic feaures, and are interested in quitting smoking. Initial eligibility screening was completed by telephone. Final eligibility screening, informed consent, treatment randomization and the baseline assessment was completed at the intake session (week 0). Patients were randomly assigned to either behavioral activation for smoking cessation (BASC) or standard behavioral treatment (ST) and either varenicline or placebo groups. That is, participants were assigned to four distinct intervention groups, including `ST + placebo`, `ST + varenicline`, `BASC + placebo`, and `BASC + varenicline.` Randomization was stratified by clinical site, sex, and level of depressive symptoms to ensure balanced representation across these factors. 


Follow-up data was collected at week 27 to assess smoking cessation outcomes, along with relevant baseline characteristics. Key variables include smoking abstinence status, demographic characteristics (sex, age, income, and education), smoking behaviors (number of cigarettes per day, time to first cigarette after getting up, and nicotine dependence score), and psychiatric measures (MDD status, anhedonia score, other diagnoses, and antidepressant usage). 

## Data Preprocessing

To prepare dataset for analysis, we firstly converted all categorical variables into factors. For socioeconomic factors, income and education, we recoded levels to improve readability and interpretability. In addition, we combined race and ethnicity indicators into a single race variable with categories including Black, Hispanic, Non-Hispanic White, Mixed Race, and Unknown.

```{r}
# factor categorical variables
data[, c("abst", "Var", "BA", "sex_ps", "NHW", 
         "Black", "Hisp", "inc", "edu", "ftcd.5.mins", 
         "otherdiag", "antidepmed", "mde_curr", 
         "Only.Menthol")] <- lapply(data[, c("abst", "Var", "BA", "sex_ps", "NHW", 
                                             "Black", "Hisp", "inc", "edu", 
                                             "ftcd.5.mins", "otherdiag", "antidepmed", 
                                             "mde_curr", "Only.Menthol")], as.factor)

# Recode factor levels in the dataset
averaged_data_factor <- data %>%
  mutate(abst = fct_recode(as.factor(abst), "Yes" = "1", "No" = "0"),
         inc = fct_recode(as.factor(inc), 
                          "Less than $20,000" = "1", 
                          "$20,000-35,000" = "2", 
                          "$35,001-50,000" = "3", 
                          "$50,001-75,000" = "4", 
                          "More than $75,000" = "5"),
         sex_ps = fct_recode(as.factor(sex_ps), "Male" = "1", "Female" = "2"),
         edu = fct_recode(as.factor(edu), 
                          "Grade School" = "1", 
                          "Some high school" = "2", 
                          "High school graduate or GED" = "3", 
                          "Some college/technical school" = "4", 
                          "College graduate" = "5"),
         ftcd.5.mins = fct_recode(as.factor(ftcd.5.mins), "Yes" = "1", "No" = "0"),
         otherdiag = fct_recode(as.factor(otherdiag), "Yes" = "1", "No" = "0"),
         antidepmed = fct_recode(as.factor(antidepmed), "Yes" = "1", "No" = "0"),
         mde_curr = fct_recode(as.factor(mde_curr), "Current MDD" = "1", "Past MDD" = "0"),
         Only.Menthol = fct_recode(as.factor(Only.Menthol), "Yes" = "1", "No" = "0"),
         race = as.factor(case_when(Black == 0 & Hisp == 0 & NHW == 0 ~ "Unknown",
                                    Black == 1 & Hisp == 1 & NHW == 1 ~ "Mixed Race",
                                    Black == 1 & Hisp == 1 ~ "Mixed Race",
                                    Black == 1 & NHW == 1 ~ "Mixed Race",
                                    NHW == 1 & Hisp == 1 ~ "Mixed Race",
                                    Black == 1 ~ "Black",
                                    Hisp == 1 ~ "Hispanic",
                                    NHW == 1 ~ "Non-Hispanic White",
                                    TRUE ~ "Other")),
         trt = as.factor(case_when(Var == 1 & BA == 1 ~ "BASC + varenicline",
                         Var == 0 & BA == 1 ~ "BASC + placebo",
                         Var == 1 & BA == 0 ~ "ST + varenicline",
                         Var == 0 & BA == 0 ~ "ST + placebo",
                         TRUE ~ NA_character_)))

averaged_data_factor$trt <- relevel(factor(averaged_data_factor$trt), ref = "ST + placebo")

averaged_data_factor <- averaged_data_factor %>%
  mutate(inc = fct_relevel(inc, "Less than $20,000", "$20,000-35,000", 
                           "$35,001-50,000", "$50,001-75,000", "More than $75,000"),
         edu = fct_relevel(edu, "Grade School", "Some high school", "High school graduate or GED",
                           "Some college/technical school", "College graduate"))

averaged_data_factor$edu <- case_when(averaged_data_factor$edu == "Grade School" ~ "Some high school & Grade School", 
                                      averaged_data_factor$edu == "Some high school" ~ "Some high school & Grade School",
                                      TRUE ~ averaged_data_factor$edu)
```


```{r}
missingness_df <- averaged_data_factor %>%
    summarise(across(everything(), ~ sum(is.na(.)))) %>%
    pivot_longer(cols = everything(), names_to = "Variable", values_to = "Missing_Count") %>%
    mutate(Total_Count = nrow(averaged_data_factor),
           Missing_Percentage = paste(round((Missing_Count / Total_Count) * 100, 2), "%")) %>%
    arrange(desc(Missing_Percentage)) %>% 
  filter(Missing_Count != 0) %>%
  dplyr::select(-Total_Count)

colnames(missingness_df) <- c("Variable", "Missing Count", "Missing Percentage")
missingness_df %>%
  kable(booktabs = TRUE, caption = "Summary of Missing Data Patterns Across Variables ") %>%
  kable_styling(font_size = 7, latex_options = c("repeat_header", "HOLD_position", "scale_down"))
```

The dataset contains varying levels of missingness across several variables as presented in `Table 1`. Nicotine Metabolism Ratio (`NMR`) has the highest missing rate, with 7% of observations missing. The FTCD score at baseline (`ftcd_score`) has the lowest missing rate, 0.33%, with only one patient missing this information. Given our limited sample size, we prefer to retain as many observations as possible for our analysis. Therefore, to address the missingness, we applied a multiple imputation approach using the `mice()` function from the `mice` package in R, generating five imputed datasets to provide plausible values for all missing entries before proceeding to the primary analysis.

## Data Exploration and Transformation

To explore potential interactions between baseline characteristics and treatment assignment on EOT abstinence, we examined the distribution of each baseline variable across treatment groups and abstinence outcomes.  

For categorical variables, bar charts show patterns across treatment groups and abstinence groups in `Figure 1` and `Figure 2.` Income in `Figure 1` exhibits different distributions among groups and abstinence outcomes. Within each treatment group, different income levels show various proportions of abstinence, suggesting that income level may be a potential predictor of treatment effect on abstinence. 

In the `BASC + placebo` group, most participants with incomes lower than \$20,000 did not achieve abstinence at the week 27 follow-up, while nearly half of those in the `ST + placebo` group with similar income level achieved abstinence. In addition, people with income ranging from \$35,001 to \$50,000 are more likely to quit smoking at the week 27 follow-up in the `BASC + placebo` group while most participants with this income level assigned to the `ST + placebo` group did not achieve abstinence. Similar variations in abstinence outcomes within income levels were observed when comparing the two behavioral treatments combined with varenicline, indicating that income level might be a potential moderator of the behavioral treatment effectiveness on the EOT abstinence among people with MDD.

```{r, out.width = "100%", fig.pos = "H", fig.align = "center", fig.height = 4}
income_stackplot <- ggplot(averaged_data_factor, aes(x = abst, fill = inc)) +
  geom_bar(position = "fill") +
  facet_wrap(~ trt) +
  labs(x = "Abstinence Status",
       y = "Proportion",
       fill = "Income Level") +
  theme_minimal() +
  scale_fill_brewer(palette = "GnBu") +
  theme(axis.title = element_text(size = 6),
        title = element_text(size = 6),
        axis.text = element_text(size = 6),
        legend.title = element_text(size = 5),
        legend.text = element_text(size = 5),
        legend.key.size = unit(0.3, "cm"),
        legend.position = "bottom",
        strip.text = element_text(size = 6)) +
  guides(fill = guide_legend(nrow = 2))

edu_stackplot <- ggplot(averaged_data_factor, aes(x = abst, fill = edu)) +
  geom_bar(position = "fill") +
  facet_wrap(~ trt) +
  labs(x = "Abstinence Status",
       y = "Proportion",
       fill = "Education Level") +
  theme_minimal() +
  scale_fill_brewer(palette = "GnBu") +
  theme(axis.title = element_text(size = 6),
        title = element_text(size = 6),
        axis.text = element_text(size = 6),
        legend.title = element_text(size = 5),
        legend.text = element_text(size = 5),
        legend.key.size = unit(0.3, "cm"),
        legend.position = "bottom",
        strip.text = element_text(size = 6)) +
  guides(fill = guide_legend(nrow = 2))

combined_plot_eduinc <- (wrap_elements(panel = income_stackplot + theme(legend.position = "bottom")) /
                           wrap_elements(panel = edu_stackplot + theme(legend.position = "bottom"))) +
  plot_layout(ncol = 2, guides = 'collect') +
  plot_annotation(title = "Figure 1: Baseline Characteristics by Abstinence Status and Treatment Group (Categorical 1)",
                  theme = theme(plot.title = element_text(size = 8, hjust = 0.5))) 

combined_plot_eduinc <- combined_plot_eduinc & theme(plot.margin = margin(10, 10, 10, 10),
                                                     legend.position = c(0.5, 0.1))

combined_plot_eduinc
```

Similarly, as shown in `Figure 1`, education level appears to impact abstinence rates across treatment groups. Within each treatment group, participants with different education levels demonstrate varying abstinence rates at follow-up. For example, observing the `BASC + placebo` group, college graduated participants are more likely to achieve abstinence at the follow up compared to those with lower education levels, suggesting that income level may be a predictor of treatment effect on abstinence. 

Additionally, comparing the two behavioral treatments with varenicline, college graduates in the `ST + varenicline` group show higher abstinence rates at week 27 than those in the `BASC + varenicline` group. Also, patients with a high school diploma or GED exhibit a higher likelihood of smoking cessation with BASC while their abstinence rate becomes much lower with ST. These findings suggest that education levels moderate the effects of behavioral treatment on EOT abstinence among individuals with MDD.

Race and the indicator of exclusive mentholated cigarette users (`Only.Menthol`) also show differences in distribution across treatment groups and outcome values, as shown in `Figure 2.` For example, in the `ST + placebo`, `BASC + placebo`, and `BASC + varenicline` groups, non-Hispanic White participants are more likely to stop smoking compared to other racial groups. This indicates that race might be a predictor of the treatment effect on EOT abstinence for people with MDD. 

Additionally, comparing the two behavioral treatments with placebo, Hispanic participants with ST are more likely to achieve smoking cessation while this pattern reverses when they were assigned to BASC. Moreover, comparing the two varenicline groups, black people with BASC show less likelihood of stopping smoking while they show a larger abstinence rate in the ST group. 

Similar pattern observed for the indicator of exclusive mentholated cigarette users (`Only.Menthol`). In the two varenicline groups, mentholated cigarette users (`Only.Menthol` = 1) with ST are more likely to achieve abstinence while these users with BASC exhibit much lower abstinence rate at week 27 follow-up. These findings suggest that race and the indicator of exclusive mentholated cigarette users could be potential predictors or moderators of the treatment effects on the EOT abstinence for people with MDD.


```{r, out.width = "100%", fig.pos = "H", fig.align = "center", fig.height = 4}
race_stackplot <- ggplot(averaged_data_factor, aes(x = abst, fill = race)) +
  geom_bar(position = "fill") +
  facet_wrap(~ trt) +
  labs(x = "Abstinence Status",
       y = "Proportion",
       fill = "Race Group") +
  theme_minimal() +
  scale_fill_brewer(palette = "GnBu") +
   theme(axis.title = element_text(size = 6),
        title = element_text(size = 6),
        axis.text = element_text(size = 6),
        legend.title = element_text(size = 5),
        legend.text = element_text(size = 5),
        legend.key.size = unit(0.3, "cm"),
        legend.position = "bottom",
        strip.text = element_text(size = 6))


only.menthol_stackplot <- ggplot(averaged_data_factor, aes(x = abst, fill = Only.Menthol)) +
  geom_bar(position = "fill") +
  facet_wrap(~ trt) +
  labs(x = "Abstinence Status",
       y = "Proportion",
       fill = "Mentholated Cigarette User") +
  theme_minimal() +
  scale_fill_brewer(palette = "GnBu") +
   theme(axis.title = element_text(size = 6),
        title = element_text(size = 6),
        axis.text = element_text(size = 6),
        legend.title = element_text(size = 5),
        legend.text = element_text(size = 5),
        legend.key.size = unit(0.3, "cm"),
        legend.position = "bottom",
        strip.text = element_text(size = 6))

combined_plot_racementhol <- (wrap_elements(panel = race_stackplot + theme(legend.position = "bottom")) /
                           wrap_elements(panel = only.menthol_stackplot + theme(legend.position = "bottom"))) +
  plot_layout(ncol = 2, guides = 'collect') +
  plot_annotation(title = "Figure 2: Baseline Characteristics by Abstinence Status and Treatment Group (Categorical 2)",
                  theme = theme(plot.title = element_text(size = 8, hjust = 0.5))) 

combined_plot_racementhol <- combined_plot_racementhol & theme(plot.margin = margin(10, 10, 10, 10),
                                                               legend.position = c(0.5, 0.1))

combined_plot_racementhol
```

We also examine the distribution of continuous variables by treatment groups and outcome status, as shown in `Figure 3` and `Figure 4`. Among continuous variables, age (`age_ps`), FTCD score, NMR, and BDI score (`bdi_score_W00`) exhibited differences in distribution across treatment groups and abstinence status at the week 27 follow-up.

Seeing `Figure 3`, the abstinence rate varies with age within the same treatment group, suggesting age as a predictor of treatment effect on EOT abstinence. Moreover, in the two placebo groups, younger participants in the `BASC + placebo` group show higher abstinence rate while this group of individuals exhibits lower abstinence rate in the `ST + placebo` group. Within the varenicline groups, middle-aged participants in ST + varenicline demonstrate significantly higher abstinence rates than middle-aged participants in BASC + varenicline.

```{r, out.width = "100%", fig.pos = "H", fig.align = "center", fig.height = 4}
ftcd_score_stackplot <- ggplot(averaged_data_factor, aes(x = ftcd_score, fill = abst)) +
  geom_density(alpha = 0.5) +
  facet_wrap(~ trt) +
  labs(x = "FTCD Score",
       y = "Density",
       fill = "Abstinence Status") +
  theme_minimal() +
  scale_fill_manual(values = c("No" = "#FF9999", "Yes" = "#99CCFF")) +
  theme(axis.title = element_text(size = 6),
        title = element_text(size = 6),
        axis.text = element_text(size = 6),
        legend.title = element_text(size = 5),
        legend.text = element_text(size = 5),
        legend.key.size = unit(0.3, "cm"),
        legend.position = "bottom",
        strip.text = element_text(size = 6))

age_stackplot <- ggplot(averaged_data_factor, aes(x = age_ps, fill = abst)) +
  geom_density(alpha = 0.5) +
  facet_wrap(~ trt) +
  labs(title = "",
       x = "Age",
       y = "Density",
       fill = "Abstinence Status") +
  theme_minimal() +
  scale_fill_manual(values = c("No" = "#FF9999", "Yes" = "#99CCFF")) +
  theme(axis.title = element_text(size = 6),
        title = element_text(size = 6),
        axis.text = element_text(size = 6),
        legend.title = element_text(size = 5),
        legend.text = element_text(size = 5),
        legend.key.size = unit(0.3, "cm"),
        legend.position = "bottom",
        strip.text = element_text(size = 6))

combined_plot_ftcdage <- (wrap_elements(panel = age_stackplot + theme(legend.position = "bottom")) /
                            wrap_elements(panel = ftcd_score_stackplot + theme(legend.position = "bottom"))) +
  plot_layout(ncol = 2, guides = 'collect') +
  plot_annotation(title = "Figure 3: Baseline Characteristics by Abstinence Status and Treatment Group (Continuous 1)",
                  theme = theme(plot.title = element_text(size = 8, hjust = 0.5))) 

combined_plot_ftcdage <- combined_plot_ftcdage & theme(plot.margin = margin(10, 10, 10, 10),
                                                       legend.position = c(0.5, 0.1))

combined_plot_ftcdage
```

```{r, out.width = "100%", fig.pos = "H", fig.align = "center", fig.height = 4}
NMR_stackplot <- ggplot(averaged_data_factor, aes(x = NMR, fill = abst)) +
  geom_density(alpha = 0.5) +
  facet_wrap(~ trt) +
  labs(x = "NMR",
       y = "Density",
       fill = "Abstinence Status") +
  theme_minimal() +
  scale_fill_manual(values = c("No" = "#FF9999", "Yes" = "#99CCFF")) +
  theme(axis.title = element_text(size = 6),
        title = element_text(size = 6),
        axis.text = element_text(size = 6),
        legend.title = element_text(size = 5),
        legend.text = element_text(size = 5),
        legend.key.size = unit(0.3, "cm"),
        legend.position = "bottom",
        strip.text = element_text(size = 6))

bdi_stackplot <- ggplot(averaged_data_factor, aes(x = bdi_score_w00, fill = abst)) +
  geom_density(alpha = 0.5) +
  facet_wrap(~ trt) +
  labs(x = "BDI Score",
       y = "Density",
       fill = "Abstinence Status") +
  theme_minimal() +
  scale_fill_manual(values = c("No" = "#FF9999", "Yes" = "#99CCFF")) +
  theme(axis.title = element_text(size = 6),
        title = element_text(size = 6),
        axis.text = element_text(size = 6),
        legend.title = element_text(size = 5),
        legend.text = element_text(size = 5),
        legend.key.size = unit(0.3, "cm"),
        legend.position = "bottom",
        strip.text = element_text(size = 6))

combined_plot_NMRbdi <- (wrap_elements(panel = NMR_stackplot + theme(legend.position = "bottom")) /
                           wrap_elements(panel = bdi_stackplot + theme(legend.position = "bottom"))) +
  plot_layout(ncol = 2, guides = 'collect') +
  plot_annotation(title = "Figure 4: Baseline Characteristics by Abstinence Status and Treatment Group (Continuous 2)",
                  theme = theme(plot.title = element_text(size = 8, hjust = 0.5))) 

combined_plot_NMRbdi <- combined_plot_NMRbdi & theme(plot.margin = margin(10, 10, 10, 10),
                                                     legend.position = c(0.5, 0.1))

combined_plot_NMRbdi
```

The FTCD score also appears to influence abstinence outcomes, with abstinence rates changing as FTCD scores vary. Moreover, participants with higher FTCD score in the `ST + placebo` group show significantly higher likelihood to continue smoking compared to those in the `BASC + placebo` group. Moreover, participants with FTCD score around 5 in the `ST + varenicline` group show higher abstinence rate compared to those in the `BASC + varenicline` group. These findings suggest potential interactions between age and behavioral treatment, as well as FTCD score-treatment and treatment. Age and FTCD score might serve as predictors and moderators of the treatment effect on the EOT abstinence.

Seeing `Figure 4`, the distribution of NMR is right skewed towards participants with higher values across all treatment groups. In the placebo groups, participants with lower NMR are more likely to quit smoking at the week 27 follow-up while this gap is less pronounced in the varenicline groups. Within the `BASC + placebo` group, there is a huge gap in abstinence rate between participants with NMRs ranging from 0.3 to 0.5. Moreover, comparing the varenicline groups, participants with NMRs between 0.3 and 0.7 show higher abstinence rate in the `ST + varenicline` group but lower abstinence rate in the `BASC + varenicline` group. 

For the BDI score (measure of depression), which reflects depressive symptom severity, distinct patterns also emerge. In the placebo groups, participants in the ST group with lower BDI scores (indicating less severe depressive symptoms) are more likely to stop smoking, while those with moderate BDI scores show lower abstinence rates. However, in the BASC group, participants show a more uniform distribution regardless of their depressive severity. The same pattern was observed when we compared the two varenicline groups, suggesting a complex interacting relationship between BDI score and the combination of behavioral and pharmacological treatments. These findings suggest that both NMR and BDI scores may interact with behavioral treatment types, influencing smoking cessation outcomes and potentially serving as moderators of treatment effects.

Additionally, examining the correlation among continuous variables shown in `Figure 5`, we observed that most variables show low to moderate correlations with each other, with both positive and negative relationships present.

```{r, out.width = "80%", fig.align='center'}
# create a correlation matrix among environmental condition factors
cor_matrix <- cor(averaged_data_factor[, c(5, 12, 14, 15, 16, 17, 18, 19, 23, 25)], use = "complete.obs")

# correlation plot of environmental condition factors
corrplot(cor_matrix, method = "color", type = "lower", 
         tl.col = "black", tl.cex = 0.8, addCoef.col = "black",
         number.cex = 0.7, col = colorRampPalette(c("steelblue", "white", "steelblue"))(200))
title("Figure 5: Correlation Plot among Environmental Condition Characteristics", 
      cex.main = 0.9, line = 3) 
```
 

To analyze the impact of behavioral treatment on end-of-treatment abstinence and examine the moderating role of baseline characteristics, we selected Lasso regression as our primary model. Since our data has limited observations compared to number of covariates, Lasso was chosen for its ability to perform both variable selection and regularization, making it particularly suited for our study, which involves numerous baseline predictors and interaction terms. By applying an L1 penalty, Lasso shrinks less relevant coefficients to zero, effectively selecting a subset of the most influential predictors and interactions. 
 
# Results

Before conducting the primary analysis, we performed exploratory data analysis (EDA) to examine baseline characteristics, assess data distributions, and identify potential relationships within the dataset.

`Table 2` presents an overall summary of statistics of patients' baseline characteristics by their behavioral and pharmacological treatment assignment. Since our study is a $2 \times 2$, factorial, randomized, placebo-controlled trial, patients are randomly assigned to either behavioral activation for smoking cessation group (BASC) or standard behavioral treatment group (ST) and either varenicline or placebo blister pack. Patients can be categorized into four treatment arm groups: BASC + placebo, BASC + varenicline, ST + placebo, and ST + varenicline. From `Table 2`, the two placebo groups both have 68 observations while the two varenicline groups have 83 and 81 observations, respectively. 

Most variables are evenly distributed across the four treatment arms, which reflects successful randomization in this factorial trial. However, a few key factors, such as socioeconomic indicators (income and education) and specific mental health variables (MDD status, DSM-5 diagnoses), exhibit slight variations that may influence outcomes. Notably, treatment arms with varenicline show higher abstinence rates than placebo groups, suggesting the potential efficacy of this pharmacotherapy in combination with behavioral interventions. While many baseline characteristics are evenly distributed across groups, some may still function as moderators, potentially interacting with treatment assignment to affect abstinence success. In addition, only one observation falls into the Grade School level in the education variable. To ensure the appropriate representation of categories, we combined the grade school level with the next level, some high school, during the regression analysis. This adjustment ensures sufficient sample sizes across categories when we split the data. 

```{r}
# create the summary table
summary_table <- averaged_data_factor %>%
  dplyr::select(-c("id", "Var", "BA", "Black", "Hisp", "NHW")) %>%
  tbl_summary(by = trt, label = list(abst ~ "Smoking abstinence",
                                     race ~ "Race",
                                     age_ps ~ "Age",
                                     sex_ps ~ "Sex",
                                     inc ~ "Income",
                                     edu ~ "Education",
                                     ftcd_score ~ "FTCD score",
                                     ftcd.5.mins ~ "Smoking within 5 mins of waking up",
                                     bdi_score_w00 ~ "BDI score",
                                     cpd_ps ~ "Cigarettes smoked per day",
                                     crv_total_pq1 ~ "Cigarette reward value",
                                     hedonsum_n_pq1 ~ "Pleasurable events (substitute reinforcers)",
                                     hedonsum_y_pq1 ~ "Pleasurable events (complementary reinforcers)",
                                     shaps_score_pq1 ~ "Anhedonia",
                                     otherdiag ~ "Other lifetime DSM-5 diagnosis",
                                     antidepmed ~ "Taking antidepressant",
                                     mde_curr ~ "Current vs. past MDD",
                                     NMR ~ "Nicotine metabolism ratio",
                                     Only.Menthol ~ "Exclusive mentholated cigarette user",
                                     readiness ~ "Readiness to quit smoking"),
              type = list(readiness ~ "continuous"),
              statistic = all_continuous() ~ "{mean} ({sd})",
              missing = "ifany",
              missing_text = "Missing") %>%
  add_overall(last = TRUE) %>%
  modify_spanning_header(update = all_stat_cols() ~ "**Behavioral and Pharmacological Treatment Assignment**") %>%
  modify_footnote(update = all_stat_cols() ~ "Mean (SD) for continuous; n (%) for categorical") %>%
  bold_labels()

summary_table %>%
  as_kable_extra(booktabs = TRUE, caption = "Participant Characteristics by Treatment Arm",
                 longtable = TRUE, linesep = "") %>%
  kableExtra::kable_styling(font_size = 7,
                            latex_options = c("repeat_header", "HOLD_position", "scale_down")) %>%
  column_spec(1, width = "3.5cm") %>%
  column_spec(2, width = "2cm") %>%
  column_spec(3, width = "2cm") %>%
  column_spec(4, width = "2cm") %>%
  column_spec(5, width = "2cm") %>%
  column_spec(6, width = "2cm") %>%
  row_spec(0, bold = TRUE, font_size = 7)
```

During the data exploration, we observed that some continuous variables were highly skewed. Since applying transformations can reduce interpretability, we decided to perform Lasso regression on both the non-transformed and transformed datasets to evaluate whether transformation is necessary in this context.

For transformed data, we applied specific transformations based on the distributional characteristics of each variable, with transformations performed after the imputation step. Among the continuous variables, pleasurable events scale of substitute reinforcers (`hedonsum_n_pq1`), pleasurable events scale of complementary reinforcers (`hedonsum_y_pq1`), measure of anhedonia (`shaps_score_pq1`), and NMR exhibit right-skewed distributions. `Table 3` summarizes the skewness value of these variables before and after transformation.

For the two pleasurable event scale variables, `hedonsum_n_pq1` and `hedonsum_y_pq1`, we applied a square root transformation to reduce high positive skewness values (1.34 and 1.39, respectively). This transformation brought their skewness close to zero (-0.06 and 0.06, respectively), resulting in more symmetric distributions. Additionally, given that `shaps_score_pq1` had nearly 50% zero entries and a high positive skewness (1.71), we explored several transformations, including log, square root, and inverse hyperbolic sine (`asinh()`). The inverse hyperbolic sine transformation produced the lowest skewness (0.52), making it the most suitable choice for this variable. Finally, we applied a log transformation on NMR which presents the highest skewness value before transformation (1.92). The log transformation successfully reduced the skewness to a nearly symmetric value. 

```{r, out.width = "80%", fig.pos = "H", fig.align = "center", fig.height = 4}
# Take transformation
averaged_data_factor_transformed <- averaged_data_factor
averaged_data_factor_transformed$shaps_score_pq1 <- asinh(averaged_data_factor$shaps_score_pq1)
averaged_data_factor_transformed$hedonsum_n_pq1 <- sqrt(averaged_data_factor$hedonsum_n_pq1)
averaged_data_factor_transformed$hedonsum_y_pq1 <- sqrt(averaged_data_factor$hedonsum_y_pq1)
averaged_data_factor_transformed$NMR <- log(averaged_data_factor$NMR)

skewness_df <- data.frame(Variable = c("hedonsum_n_pq1", "hedonsum_y_pq1", "shaps_score_pq1", "NMR"),
                          transformation = c("Square Root Transformation",
                                             "Square Root Transformation",
                                             "Inverse Hyperbolic Sine Transformation",
                                             "Log Transformation"),
                          skewness_before = c(skewness(averaged_data_factor$hedonsum_n_pq1),
                                              skewness(averaged_data_factor$hedonsum_y_pq1),
                                              skewness(averaged_data_factor$shaps_score_pq1, na.rm = TRUE),
                                              skewness(averaged_data_factor$NMR, na.rm = TRUE)),
                          skewness_after = c(skewness(averaged_data_factor_transformed$hedonsum_n_pq1),
                                             skewness(averaged_data_factor_transformed$hedonsum_y_pq1),
                                             skewness(averaged_data_factor_transformed$shaps_score_pq1, na.rm = TRUE),
                                             skewness(averaged_data_factor_transformed$NMR, na.rm = TRUE)))

colnames(skewness_df) <- c("Variable", "Transformation", 
                           "Skewness before Transformation", "Skewness after Transformation" )

skewness_df %>%
  kable(booktabs = TRUE, caption = "Variable Transformation on Skewness") %>%
  kable_styling(font_size = 7, latex_options = c("repeat_header", "HOLD_position", "scale_down")) %>%
  column_spec(1, width = "2cm") %>% 
  column_spec(2, width = "4cm") %>%
  column_spec(3, width = "3.5cm") %>%
  column_spec(4, width = "3.5cm")
```


As mentioned earlier, we performed multiple imputation using the `mice()` function to generate five different imputed data to address missingness. We then applied transformations listed in `Table 2` to the corresponding skewed variables in each imputed dataset. 

With transformed and non-transformed data list, each imputed dataset was then split into a 70% training set and a 30% test set, stratified by treatment group using the `createDataPartition()` function in the `caret` package. Lasso regression was conducted on each training set using `cv.glmnet()` with a design matrix that included all baseline characteristics and their interactions with the behavioral and pharmacological treatment, respectively. To ensure consistent treatment group distribution across each cross-validation fold in lasso regression, we created custom fold assignments by treatment level and specified these assignments through the `foldid` argument in `cv.glmnet()`. 

During cross-validation, we identified the optimal regularization parameter, `lambda.min`, which minimized the cross-validated error, and extracted the coefficient estimates for each lasso model at this optimal lambda value. Finally, we averaged the coefficient estimates from all five Lasso models to obtain the final pooled estimates, presented in `Table 4` and `Table 5`.

```{r}
# Set working directory
# Windows
setwd("C:/Users/yingx/OneDrive/Desktop/Fall 2024/PHP 2550/Data/")

# Mac
# setwd("~/Desktop/Fall 2024/PHP 2550/Data/")

# Read in data
data <- read.csv("project2.csv")

# Factor categorical variables
data[, c("abst", "Var", "BA", "sex_ps", "NHW", 
         "Black", "Hisp", "inc", "edu", "ftcd.5.mins", 
         "otherdiag", "antidepmed", "mde_curr", 
         "Only.Menthol")] <- lapply(data[, c("abst", "Var", "BA", "sex_ps", "NHW", 
                                             "Black", "Hisp", "inc", "edu", 
                                             "ftcd.5.mins", "otherdiag", "antidepmed", 
                                             "mde_curr", "Only.Menthol")], as.factor)

# Multiple imputation with m = 5
new_data <- data[, -1]
imputed_data <- mice(new_data, m = 5, method = 'pmm', seed = 2550, printFlag = FALSE)

# Extract the five imputed datasets into a list
completed_datasets <- list()
for (i in 1:5) {
  completed_datasets[[i]] <- complete(imputed_data, i)
}

for (i in 1:length(completed_datasets)) {
  completed_datasets[[i]] <- completed_datasets[[i]] %>%
    mutate(trt = as.factor(case_when(Var == 1 & BA == 1 ~ "BASC + varenicline",
                                     Var == 0 & BA == 1 ~ "BASC + placebo",
                                     Var == 1 & BA == 0 ~ "ST + varenicline",
                                     Var == 0 & BA == 0 ~ "ST + placebo",
                                     TRUE ~ NA_character_)),
           race = as.factor(case_when(Black == 0 & Hisp == 0 & NHW == 0 ~ "Unknown",
                                      Black == 1 & Hisp == 1 & NHW == 1 ~ "Mixed Race",
                                      Black == 1 & Hisp == 1 ~ "Mixed Race",
                                      Black == 1 & NHW == 1 ~ "Mixed Race",
                                      NHW == 1 & Hisp == 1 ~ "Mixed Race",
                                      Black == 1 ~ "Black",
                                      Hisp == 1 ~ "Hispanic",
                                      NHW == 1 ~ "Non-Hispanic White",
                                      TRUE ~ "Other")),
           inc = fct_recode(as.factor(inc), 
                            "Less than $20,000" = "1", 
                            "$20,000-35,000" = "2", 
                            "$35,001-50,000" = "3", 
                            "$50,001-75,000" = "4", 
                            "More than $75,000" = "5"),
           edu = fct_collapse(as.factor(edu),
                             "Some high school & Grade School" = c("1", "2"),
                             "High school graduate or GED" = "3",
                             "Some college/technical school" = "4",
                             "College graduate" = "5")) %>%
    mutate(inc = fct_relevel(inc, "Less than $20,000", "$20,000-35,000", 
                             "$35,001-50,000", "$50,001-75,000", "More than $75,000"),
           edu = fct_relevel(edu, "Some high school & Grade School", 
                             "High school graduate or GED", 
                             "Some college/technical school", "College graduate")) %>%
    mutate(trt = relevel(factor(trt), ref = "ST + placebo"))

  # Apply transformations
  completed_datasets[[i]]$shaps_score_pq1 <- asinh(completed_datasets[[i]]$shaps_score_pq1)
  completed_datasets[[i]]$hedonsum_n_pq1 <- sqrt(completed_datasets[[i]]$hedonsum_n_pq1)
  completed_datasets[[i]]$hedonsum_y_pq1 <- sqrt(completed_datasets[[i]]$hedonsum_y_pq1)
  completed_datasets[[i]]$NMR <- log(completed_datasets[[i]]$NMR)
}
```

```{r}
# Extract the five imputed datasets into a list
completed_datasets_nontrans <- list()
for (i in 1:5) {
  completed_datasets_nontrans[[i]] <- complete(imputed_data, i)
}

for (i in 1:length(completed_datasets_nontrans)) {
  completed_datasets_nontrans[[i]] <- completed_datasets_nontrans[[i]] %>%
    mutate(trt = as.factor(case_when(Var == 1 & BA == 1 ~ "BASC + varenicline",
                                     Var == 0 & BA == 1 ~ "BASC + placebo",
                                     Var == 1 & BA == 0 ~ "ST + varenicline",
                                     Var == 0 & BA == 0 ~ "ST + placebo",
                                     TRUE ~ NA_character_)),
           race = as.factor(case_when(Black == 0 & Hisp == 0 & NHW == 0 ~ "Unknown",
                                      Black == 1 & Hisp == 1 & NHW == 1 ~ "Mixed Race",
                                      Black == 1 & Hisp == 1 ~ "Mixed Race",
                                      Black == 1 & NHW == 1 ~ "Mixed Race",
                                      NHW == 1 & Hisp == 1 ~ "Mixed Race",
                                      Black == 1 ~ "Black",
                                      Hisp == 1 ~ "Hispanic",
                                      NHW == 1 ~ "Non-Hispanic White",
                                      TRUE ~ "Other")),
           inc = fct_recode(as.factor(inc), 
                            "Less than $20,000" = "1", 
                            "$20,000-35,000" = "2", 
                            "$35,001-50,000" = "3", 
                            "$50,001-75,000" = "4", 
                            "More than $75,000" = "5"),
           edu = fct_collapse(as.factor(edu),
                             "Some high school & Grade School" = c("1", "2"),
                             "High school graduate or GED" = "3",
                             "Some college/technical school" = "4",
                             "College graduate" = "5")) %>%
    mutate(inc = fct_relevel(inc, "Less than $20,000", "$20,000-35,000", 
                             "$35,001-50,000", "$50,001-75,000", "More than $75,000"),
           edu = fct_relevel(edu, "Some high school & Grade School", 
                             "High school graduate or GED", 
                             "Some college/technical school", "College graduate")) %>%
    mutate(trt = relevel(factor(trt), ref = "ST + placebo"))
}
```

```{r}
lasso_model_function_moderator <- function(data_list) {
  lasso_coef <- list()
  
  for (index in seq_along(data_list)) {
    data <- data_list[[index]]
    
    # Split train and test sets
    set.seed(2550)
    train_index <- createDataPartition(data$trt, p = 0.7, list = FALSE)
    train_data <- data[train_index, ]
    test_data <- data[-train_index, ]
    
    # Create fold IDs for cross-validation
    train_data$foldid <- NA
    for (trt_level in unique(train_data$trt)) {
      treatment_data <- train_data[train_data$trt == trt_level, ]
      fold_ids <- sample(rep(1:5, length.out = nrow(treatment_data)))
      train_data$foldid[train_data$trt == trt_level] <- fold_ids
    }
    
    # Define model matrix
    X <- model.matrix(abst ~ BA * (age_ps + sex_ps + inc + edu + ftcd_score + ftcd.5.mins +
                                    bdi_score_w00 + cpd_ps + crv_total_pq1 + hedonsum_n_pq1 + hedonsum_y_pq1 +
                                    shaps_score_pq1 + otherdiag + antidepmed + mde_curr + NMR + Only.Menthol +
                                    readiness + race) +
                        Var * (age_ps + sex_ps + inc + edu + ftcd_score + ftcd.5.mins +
                                    bdi_score_w00 + cpd_ps + crv_total_pq1 + hedonsum_n_pq1 + hedonsum_y_pq1 +
                                    shaps_score_pq1 + otherdiag + antidepmed + mde_curr + NMR + Only.Menthol +
                                    readiness + race), data = train_data)[, -1]
    y <- train_data$abst
    
    # Fit lasso with cross-validation using custom foldid
    cv_model <- cv.glmnet(X, y, family = "binomial", alpha = 1, nfolds = 5, 
                          foldid = train_data$foldid, nlambda = 100)
    best_lambda <- cv_model$lambda.min
    
    # Fit final lasso model using best lambda
    lasso_model <- glmnet(X, y, family = "binomial", alpha = 1, lambda = best_lambda)
    
    # Extract coefficients and store in a data frame
    coefficients <- as.data.frame(as.matrix(coef(lasso_model)))
    coefficients$Variable <- rownames(coefficients)
    rownames(coefficients) <- NULL
    colnames(coefficients)[1] <- "Estimates"
    
    # Store coefficients in list
    lasso_coef[[index]] <- coefficients
  }
  
  # Return list of coefficients for all imputed datasets
  return(lasso_coef)
}
```

```{r}
# Run the lasso model function with transformed data
lasso_coef_results_moderator <- lasso_model_function_moderator(completed_datasets)

coef_imputation_df <- Reduce(function(x, y) merge(x, y, by = "Variable"), lasso_coef_results_moderator)
names(coef_imputation_df) <- c("Variable", "Imputation1", "Imputation2", "Imputation3", "Imputation4", "Imputation5")
coef_imputation_df <- coef_imputation_df %>%
  filter(Imputation1 != 0 | Imputation2 != 0 | Imputation3 != 0 | Imputation4 != 0 | Imputation5 != 0)

coef_imputation_df$SortCategory <- c(1, 4, 3, 3, 3, 4, 4, 2, 2, 2, 2, 4, 4, 2, 2, 4)

coef_imputation_df <- coef_imputation_df[order(coef_imputation_df$SortCategory, coef_imputation_df$Variable), ] %>%
  dplyr::select(-c("SortCategory"))

names(coef_imputation_df) <- c("Variable", "Imputation 1", "Imputation 2", "Imputation 3", "Imputation 4", "Imputation 5") 

# coef_imputation_df %>%
#   kable(booktabs = TRUE, caption = "Lasso Model Coefficient Estimate (With Transformation)") %>%
#   kable_styling(font_size = 7, latex_options = c("repeat_header", "HOLD_position", "scale_down")) %>%
#   column_spec(1, width = "0.5cm") %>%
#   column_spec(2, width = "2.5cm") %>%
#   column_spec(3, width = "1.5cm") %>%
#   column_spec(4, width = "1.5cm") %>%
#   column_spec(5, width = "1.5cm") %>%
#   column_spec(6, width = "1.5cm") %>%
#   column_spec(7, width = "1.5cm")
```

```{r}
# Generate combined coefficient data frame
imputed_coefs_list_moderator <- list()
for (i in seq_along(lasso_coef_results_moderator)) {
  coefs <- lasso_coef_results_moderator[[i]]
  colnames(coefs)[colnames(coefs) == "Estimates"] <- paste0("Estimates_", i)
  imputed_coefs_list_moderator[[i]] <- coefs[, c("Variable", paste0("Estimates_", i))]
}

# Combine and pool estimates
wide_format_coefficients_moderator <- Reduce(function(x, y) merge(x, y, by = "Variable", all = TRUE), imputed_coefs_list_moderator)
wide_format_coefficients_moderator$Pooled_Estimate <- rowMeans(wide_format_coefficients_moderator[ , grep("Estimates_", names(wide_format_coefficients_moderator))], na.rm = TRUE)

coef_table_moderator <- wide_format_coefficients_moderator %>%
  filter(Pooled_Estimate != 0) %>%
  dplyr::select(c("Variable", "Pooled_Estimate"))

colnames(coef_table_moderator)[2] <- "Estimate"
coef_table_moderator$exp_estimate <- exp(coef_table_moderator$Estimate)
```

```{r}
# Order main effects and interactions
main_effects <- coef_table_moderator[!grepl(":", coef_table_moderator$Variable), ]
interaction_terms <- coef_table_moderator[grepl(":", coef_table_moderator$Variable), ]
age_interaction <- coef_table_moderator[coef_table_moderator$Variable == "age_ps:Var1", ]

# Combine for final ordered result
ordered_model_results <- rbind(main_effects, interaction_terms)[-8,]
ordered_model_results <- rbind(ordered_model_results, age_interaction)
rownames(ordered_model_results) <- NULL
colnames(ordered_model_results)[3] <- "Exponential Estimate"

trans_coef <- left_join(coef_imputation_df, ordered_model_results, by = "Variable") %>%
  dplyr::select(-8)

names(trans_coef)[7] <- "Pooled Estimate"

# Display results
trans_coef %>%
  kable(booktabs = TRUE, caption = "Lasso Model Coefficient Estimate (With Transformation)") %>%
  kable_styling(font_size = 7, latex_options = c("repeat_header", "HOLD_position", "scale_down")) %>%
  column_spec(1, width = "4cm") %>%
  column_spec(2, width = "1.5cm") %>%
  column_spec(3, width = "1.5cm") %>%
  column_spec(4, width = "1.5cm") %>%
  column_spec(5, width = "1.5cm") %>%
  column_spec(6, width = "1.5cm") %>%
  column_spec(7, width = "2cm")
```

```{r}
# Run the lasso model function with data none transformation
lasso_coef_results_moderator_nontrans <- lasso_model_function_moderator(completed_datasets_nontrans)

coef_imputation_df_nontrans <- Reduce(function(x, y) merge(x, y, by = "Variable"), lasso_coef_results_moderator_nontrans)
names(coef_imputation_df_nontrans) <- c("Variable", "Imputation1", "Imputation2", "Imputation3", "Imputation4", "Imputation5")
coef_imputation_df_nontrans <- coef_imputation_df_nontrans %>%
  filter(Imputation1 != 0 | Imputation2 != 0 | Imputation3 != 0 | Imputation4 != 0 | Imputation5 != 0)

# coef_imputation_df_nontrans$SortCategory <- c(1, 4, 3, 4, 4, 2, 2, 4, 4, 4, 2, 4)
coef_imputation_df_nontrans$SortCategory <- c(1, 4, 3, 4, 4, 2, 2, 4, 4, 2)

coef_imputation_df_nontrans <- coef_imputation_df_nontrans[order(coef_imputation_df_nontrans$SortCategory, coef_imputation_df_nontrans$Variable), ] %>%
  dplyr::select(-c("SortCategory"))

names(coef_imputation_df_nontrans) <- c("Variable", "Imputation 1", "Imputation 2", "Imputation 3", "Imputation 4", "Imputation 5") 

# coef_imputation_df_nontrans %>%
#   kable(booktabs = TRUE, caption = "Lasso Model Coefficient Estimate (No Transformation)") %>%
#   kable_styling(font_size = 7, latex_options = c("repeat_header", "HOLD_position", "scale_down")) %>%
#   column_spec(1, width = "0.5cm") %>%
#   column_spec(2, width = "2.5cm") %>%
#   column_spec(3, width = "1.5cm") %>%
#   column_spec(4, width = "1.5cm") %>%
#   column_spec(5, width = "1.5cm") %>%
#   column_spec(6, width = "1.5cm") %>%
#   column_spec(7, width = "1.5cm")
```

```{r}
# Generate combined coefficient data frame
imputed_coefs_list_moderator_nontrans <- list()
for (i in seq_along(lasso_coef_results_moderator_nontrans)) {
  coefs <- lasso_coef_results_moderator_nontrans[[i]]
  colnames(coefs)[colnames(coefs) == "Estimates"] <- paste0("Estimates_", i)
  imputed_coefs_list_moderator_nontrans[[i]] <- coefs[, c("Variable", paste0("Estimates_", i))]
}

# Combine and pool estimates
wide_format_coefficients_moderator_nontrans <- Reduce(function(x, y) merge(x, y, by = "Variable", all = TRUE), imputed_coefs_list_moderator_nontrans)
wide_format_coefficients_moderator_nontrans$Pooled_Estimate <- rowMeans(wide_format_coefficients_moderator_nontrans[ , grep("Estimates_", names(wide_format_coefficients_moderator_nontrans))], na.rm = TRUE)

coef_table_moderator_nontrans <- wide_format_coefficients_moderator_nontrans %>%
  filter(Pooled_Estimate != 0) %>%
  dplyr::select(c("Variable", "Pooled_Estimate"))

colnames(coef_table_moderator_nontrans)[2] <- "Estimate"
coef_table_moderator_nontrans$exp_estimate <- exp(coef_table_moderator_nontrans$Estimate)
```

```{r}
# Order main effects and interactions
main_effects_nontrans <- coef_table_moderator_nontrans[!grepl(":", coef_table_moderator_nontrans$Variable), ]
interaction_terms_nontrans <- coef_table_moderator_nontrans[grepl(":", coef_table_moderator_nontrans$Variable), ]
age_interaction_nontrans <- coef_table_moderator_nontrans[coef_table_moderator_nontrans$Variable == "age_ps:Var1", ]

# Combine for final ordered result
ordered_model_results_nontrans <- rbind(main_effects_nontrans, interaction_terms_nontrans)[-5,]
ordered_model_results_nontrans <- rbind(ordered_model_results_nontrans, age_interaction_nontrans)
rownames(ordered_model_results_nontrans) <- NULL
colnames(ordered_model_results_nontrans)[3] <- "Exponential Estimate"

nontrans_coef <- left_join(coef_imputation_df_nontrans, ordered_model_results_nontrans, by = "Variable") %>%
  dplyr::select(-8)

names(nontrans_coef)[7] <- "Pooled Estimate"

# Display results
nontrans_coef %>%
  kable(booktabs = TRUE, caption = "Lasso Model Coefficient Estimate (No Transformation)") %>%
  kable_styling(font_size = 7, latex_options = c("repeat_header", "HOLD_position", "scale_down")) %>%
  column_spec(1, width = "4cm") %>%
  column_spec(2, width = "1.5cm") %>%
  column_spec(3, width = "1.5cm") %>%
  column_spec(4, width = "1.5cm") %>%
  column_spec(5, width = "1.5cm") %>%
  column_spec(6, width = "1.5cm") %>%
  column_spec(7, width = "2cm")
```

Examining the results of Lasso regression on both the transformed and non-transformed datasets, we decided to retain the transformation. Comparing `Table 4` and `Table 5`, we found key skewed variables such as `NMR` and `hedonsum_n_pq1` became significant with transformation while are dropped with non-transformed data, indicating that the transformation better captured the relationships between these variables and the outcome. In addition, we generate the ROC curve for training and test set with both datasets shown in `Figure 6`. The AUC exhibits a slight increase of 0.02 for the training set after applying transformation and it increases by 0.01 for the test set with transformation. The calibration plots shown in `Figure 7` do not provide clear or conclusive insights into whether transformations significantly improve the model. While transformations can reduce interpretability, the improved model performance and increased significance of skewed variables justify their use in this context. By applying transformations, we aim to achieve a more robust and accurate model without compromising key insights.

```{r}
long_data_train <- data.frame()
long_data_test <- data.frame()

# get stratified training index based on treatment group
set.seed(2550)
train_index <- createDataPartition(completed_datasets[[1]]$trt, p = 0.7, list = FALSE)

# generate long format of train and test dataframe from the five imputed datasets
for (i in 1:length(completed_datasets)) {
  imputed_dataset <- completed_datasets[[i]]
  train_set <- imputed_dataset[train_index, ]
  test_set <- imputed_dataset[-train_index, ]
  
  long_data_train <- rbind(long_data_train, train_set)
  long_data_test <- rbind(long_data_test, test_set)
}
```

```{r}
# create the design matrix with interaction terms
long_data_matrix_train <- model.matrix(abst ~ BA * (age_ps + sex_ps + inc + edu + ftcd_score + ftcd.5.mins +
                                    bdi_score_w00 + cpd_ps + crv_total_pq1 + hedonsum_n_pq1 + hedonsum_y_pq1 +
                                    shaps_score_pq1 + otherdiag + antidepmed + mde_curr + NMR + Only.Menthol +
                                    readiness + race)  +
                             Var * (age_ps + sex_ps + inc + edu + ftcd_score + ftcd.5.mins +
                                    bdi_score_w00 + cpd_ps + crv_total_pq1 + hedonsum_n_pq1 + hedonsum_y_pq1 +
                                    shaps_score_pq1 + otherdiag + antidepmed + mde_curr + NMR + Only.Menthol +
                                    readiness + race),
                                       data = long_data_train)

# convert the design matrix to a data frame
long_data_trainset <- as.data.frame(long_data_matrix_train)

# extract the intercept from pooled coefficients
pooled_intercept <- wide_format_coefficients_moderator %>%
  filter(Variable == "(Intercept)") %>%
  pull(Pooled_Estimate)

# extract only non-intercept pooled coefficients
pooled_coefs <- wide_format_coefficients_moderator %>%
  filter(Variable != "(Intercept)")

# ensure the predictor variables in the data match those in pooled coefficients
predictor_vars <- pooled_coefs$Variable
long_data_trainset <- long_data_trainset[, predictor_vars, drop = FALSE] 

# calculate log-odds using matrix multiplication with pooled coefficients
long_data_trainset$log_odds <- pooled_intercept + as.matrix(long_data_trainset) %*% pooled_coefs$Pooled_Estimate

# convert log-odds to probabilities
long_data_trainset$predicted_prob <- 1 / (1 + exp(-long_data_trainset$log_odds))
```

```{r}
# create the design matrix with interaction terms
long_data_matrix_test <- model.matrix(abst ~ BA * (age_ps + sex_ps + inc + edu + ftcd_score + ftcd.5.mins +
                                    bdi_score_w00 + cpd_ps + crv_total_pq1 + hedonsum_n_pq1 + hedonsum_y_pq1 +
                                    shaps_score_pq1 + otherdiag + antidepmed + mde_curr + NMR + Only.Menthol +
                                    readiness + race) +
                                      Var * (age_ps + sex_ps + inc + edu + ftcd_score + ftcd.5.mins +
                                    bdi_score_w00 + cpd_ps + crv_total_pq1 + hedonsum_n_pq1 + hedonsum_y_pq1 +
                                    shaps_score_pq1 + otherdiag + antidepmed + mde_curr + NMR + Only.Menthol +
                                    readiness + race),
                                 data = long_data_test)

# convert the design matrix to a data frame
long_data_testset <- as.data.frame(long_data_matrix_test)

# ensure the predictor variables in the data match those in pooled coefficients
long_data_testset <- long_data_testset[, predictor_vars, drop = FALSE] 

# calculate log-odds using matrix multiplication with pooled coefficients
long_data_testset$log_odds <- pooled_intercept + as.matrix(long_data_testset) %*% pooled_coefs$Pooled_Estimate

# convert log-odds to probabilities
long_data_testset$predicted_prob <- 1 / (1 + exp(-long_data_testset$log_odds))
```

```{r}
long_data_train_nontrans <- data.frame()
long_data_test_nontrans <- data.frame()

# get stratified training index based on treatment group
set.seed(2550)
train_index <- createDataPartition(completed_datasets[[1]]$trt, p = 0.7, list = FALSE)

# generate long format of train and test dataframe from the five imputed datasets
for (i in 1:length(completed_datasets_nontrans)) {
  imputed_dataset <- completed_datasets_nontrans[[i]]
  train_set <- imputed_dataset[train_index, ]
  test_set <- imputed_dataset[-train_index, ]
  
  long_data_train_nontrans <- rbind(long_data_train_nontrans, train_set)
  long_data_test_nontrans <- rbind(long_data_test_nontrans, test_set)
}
```

```{r}
# create the design matrix with interaction terms
long_data_matrix_train_nontrans <- model.matrix(abst ~ BA * (age_ps + sex_ps + inc + edu + ftcd_score + ftcd.5.mins +
                                    bdi_score_w00 + cpd_ps + crv_total_pq1 + hedonsum_n_pq1 + hedonsum_y_pq1 +
                                    shaps_score_pq1 + otherdiag + antidepmed + mde_curr + NMR + Only.Menthol +
                                    readiness + race)  +
                             Var * (age_ps + sex_ps + inc + edu + ftcd_score + ftcd.5.mins +
                                    bdi_score_w00 + cpd_ps + crv_total_pq1 + hedonsum_n_pq1 + hedonsum_y_pq1 +
                                    shaps_score_pq1 + otherdiag + antidepmed + mde_curr + NMR + Only.Menthol +
                                    readiness + race),
                                       data = long_data_train_nontrans)

# convert the design matrix to a data frame
long_data_trainset_nontrans <- as.data.frame(long_data_matrix_train_nontrans)

# extract the intercept from pooled coefficients
pooled_intercept_nontrans <- wide_format_coefficients_moderator_nontrans %>%
  filter(Variable == "(Intercept)") %>%
  pull(Pooled_Estimate)

# extract only non-intercept pooled coefficients
pooled_coefs_nontrans <- wide_format_coefficients_moderator_nontrans %>%
  filter(Variable != "(Intercept)")

# ensure the predictor variables in the data match those in pooled coefficients
predictor_vars_nontrans <- pooled_coefs_nontrans$Variable
long_data_trainset_nontrans <- long_data_trainset_nontrans[, predictor_vars_nontrans, drop = FALSE] 

# calculate log-odds using matrix multiplication with pooled coefficients
long_data_trainset_nontrans$log_odds <- pooled_intercept_nontrans + as.matrix(long_data_trainset_nontrans) %*% pooled_coefs_nontrans$Pooled_Estimate

# convert log-odds to probabilities
long_data_trainset_nontrans$predicted_prob <- 1 / (1 + exp(-long_data_trainset_nontrans$log_odds))
```

```{r}
# create the design matrix with interaction terms
long_data_matrix_test_nontrans <- model.matrix(abst ~ BA * (age_ps + sex_ps + inc + edu + ftcd_score + ftcd.5.mins +
                                    bdi_score_w00 + cpd_ps + crv_total_pq1 + hedonsum_n_pq1 + hedonsum_y_pq1 +
                                    shaps_score_pq1 + otherdiag + antidepmed + mde_curr + NMR + Only.Menthol +
                                    readiness + race) +
                                      Var * (age_ps + sex_ps + inc + edu + ftcd_score + ftcd.5.mins +
                                    bdi_score_w00 + cpd_ps + crv_total_pq1 + hedonsum_n_pq1 + hedonsum_y_pq1 +
                                    shaps_score_pq1 + otherdiag + antidepmed + mde_curr + NMR + Only.Menthol +
                                    readiness + race),
                                 data = long_data_test_nontrans)

# convert the design matrix to a data frame
long_data_testset_nontrans <- as.data.frame(long_data_matrix_test_nontrans)

# ensure the predictor variables in the data match those in pooled coefficients
long_data_testset_nontrans <- long_data_testset_nontrans[, predictor_vars_nontrans, drop = FALSE] 

# calculate log-odds using matrix multiplication with pooled coefficients
long_data_testset_nontrans$log_odds <- pooled_intercept_nontrans + as.matrix(long_data_testset_nontrans) %*% pooled_coefs_nontrans$Pooled_Estimate

# convert log-odds to probabilities
long_data_testset_nontrans$predicted_prob <- 1 / (1 + exp(-long_data_testset_nontrans$log_odds))
```

```{r, out.width = "80%", fig.pos = "H", fig.align = "center", fig.height = 4}
# do roc on train and test sets
auc_result_nontrans <- roc(long_data_train_nontrans$abst, long_data_trainset_nontrans$predicted_prob)
auc_result_test_nontrans <- roc(long_data_test_nontrans$abst, long_data_testset_nontrans$predicted_prob)

auc_result <- roc(long_data_train$abst, long_data_trainset$predicted_prob)
auc_result_test <- roc(long_data_test$abst, long_data_testset$predicted_prob)

# plot roc for both sets
par(mfrow= c(1,2), oma = c(0, 0, 2, 0))
plot(auc_result_nontrans, main = "No Transformation", col = "blue", lwd = 1.5, 
     cex.main = 0.7, cex.lab = 0.6, cex.axis = 0.5)
plot(auc_result_test_nontrans, add = TRUE, col = "red", lwd = 1.5)
text(0.82, 0.8, paste("AUC =", round(auc(auc_result_nontrans), 2)), col = "blue", cex = 0.5)
text(0.5, 0.65, paste("AUC =", round(auc(auc_result_test_nontrans), 2)), col = "red", cex = 0.5)
legend("bottomright", legend = c("Train", "Test"), col = c("blue", "red"), lwd = 1, cex = 0.5)

plot(auc_result, main = "With Transformation", col = "blue", lwd = 1.5,
     cex.main = 0.7, cex.lab = 0.6, cex.axis = 0.5)
plot(auc_result_test, add = TRUE, col = "red", lwd = 1.5)
text(0.82, 0.8, paste("AUC =", round(auc(auc_result), 2)), col = "blue", cex = 0.5)
text(0.5, 0.65, paste("AUC =", round(auc(auc_result_test), 2)), col = "red", cex = 0.5)
legend("bottomright", legend = c("Train", "Test"), col = c("blue", "red"), lwd = 1, cex = 0.5)
mtext("Figure 6: ROC Curves Comparison", outer = TRUE, cex = 0.8)
```

```{r, out.width = "70%", fig.pos = "H", fig.align = "center", fig.height = 5}
long_data_trainset <- long_data_trainset %>%
  mutate(abst_num = as.numeric(as.character(long_data_train$abst)))
long_data_testset <- long_data_testset %>%
  mutate(abst_num = as.numeric(as.character(long_data_test$abst)))

cal_plot_train <- calibration_plot(data = long_data_trainset, obs = "abst_num", 
                                   pred = "predicted_prob", title = "Train Data (With Transformation)", 
                                   y_lim = c(0, 1), x_lim=c(0, 1)) 
cal_plot_train <- cal_plot_train$calibration_plot
cal_plot_train <- cal_plot_train +
  theme(plot.title = element_text(size = 8),
        axis.title.x = element_text(size = 6), axis.title.y = element_text(size = 6),
        axis.text.x = element_text(size = 4), axis.text.y = element_text(size = 4))

cal_plot_test <- calibration_plot(data = long_data_testset, obs = "abst_num", 
                                  pred = "predicted_prob", title = "Test Data (With Transformation)", 
                                  y_lim = c(0, 1), x_lim=c(0, 1))
cal_plot_test <- cal_plot_test$calibration_plot
cal_plot_test <- cal_plot_test +
  theme(plot.title = element_text(size = 8),
        axis.title.x = element_text(size = 6), axis.title.y = element_text(size = 6),
        axis.text.x = element_text(size = 4), axis.text.y = element_text(size = 4))


long_data_trainset_nontrans <- long_data_trainset_nontrans %>%
  mutate(abst_num = as.numeric(as.character(long_data_train_nontrans$abst)))
long_data_testset_nontrans <- long_data_testset_nontrans %>%
  mutate(abst_num = as.numeric(as.character(long_data_test_nontrans$abst)))

cal_plot_train_nontrans <- calibration_plot(data = long_data_trainset_nontrans, obs = "abst_num", 
                                            pred = "predicted_prob", title = "Train Data (No Transformation)", 
                                            y_lim = c(0, 1), x_lim=c(0, 1))
cal_plot_train_nontrans <- cal_plot_train_nontrans$calibration_plot
cal_plot_train_nontrans <- cal_plot_train_nontrans +
  theme(plot.title = element_text(size = 8),
        axis.title.x = element_text(size = 6), axis.title.y = element_text(size = 6),
        axis.text.x = element_text(size = 4), axis.text.y = element_text(size = 4))

cal_plot_test_nontrans <- calibration_plot(data = long_data_testset_nontrans, obs = "abst_num", 
                                           pred = "predicted_prob", title = "Test Data (No Transformation)", 
                                           y_lim = c(0, 1), x_lim=c(0, 1))

cal_plot_test_nontrans <- cal_plot_test_nontrans$calibration_plot
cal_plot_test_nontrans <- cal_plot_test_nontrans +
  theme(plot.title = element_text(size = 8),
        axis.title.x = element_text(size = 6), axis.title.y = element_text(size = 6),
        axis.text.x = element_text(size = 4), axis.text.y = element_text(size = 4))

grid.arrange(cal_plot_train_nontrans, cal_plot_test_nontrans,
             cal_plot_train, cal_plot_test, ncol = 2,
             top = text_grob("Figure 7: Calibration Plot Comparison"))
```

In addition to the primary analysis, we employed bootstrap resampling to evaluate the stability and reliability of the model coefficients and predictions (code can be found in `Bootstrap.Rmd`). We performed a bootstrap procedure with 200 iterations on the imputed datasets. In each iteration, we generated a bootstrap sample from the dataset and split it into training and testing subsets. The Lasso regression model was fitted to the training data using 5-fold cross-validation to identify the optimal regularization parameter ($\lambda$), ensuring robust variable selection. Coefficients from the final Lasso model were extracted for each bootstrap iteration and stored for further analysis. This method allowed us to quantify the variability of coefficient estimates and identify consistently important predictors across the bootstrap samples. To summarize the results, we calculated the mean coefficient estimates, 95% confidence intervals, and the proportion of times each variable was selected as significant across iterations with a csv file saved within the `Boostrap_Results` folder named as `summary_results.csv`. Variables selected more than one-third of the time were identified as significant. These significant variables, along with their pooled estimates, confidence intervals, and selection proportions, are presented in `Table 6`.

Observing the model coefficient without bootstrap shown in `Table 4`, we find that among the main effect variables, `ftcd_score`, `hedonsum_n_pq1`, and `readiness` present significant negative coefficient estimates as a predictor of smoking abstinence. This indicates that, holding other factors, higher nicotine dependence levels, higher values of the square root-transformed pleasurable events scale of substitute reinforcers, and greater baseline readiness to quit smoking are associated with reduced odds of smoking cessation at week 27. However, with `hedonsum_n_pq1` and `readiness` only exhibit significant in one imputed dataset, the effect of these two factors on abstinence might be relatively minor. Similarly, the variable `mde_curr`, indicating current Major Depressive Disorder (MDD), also has a significant negative coefficient estimate, suggesting that individuals with MDD are less likely to achieve abstinence, all else being equal.

In contrast, again as predictors, `NMR` and the race variable (Non-Hispanic White) have significant positive coefficient estimates. These findings suggest that higher log-transformed NMR values and identifying as Non-Hispanic White are positively associated with higher odds of smoking cessation, holding other factors constant. 

The interaction terms between behavioral treatment and the income variable (\$35,001–50,000), the binary indicator of exclusive mentholated cigarette use, and the race variable (Non-Hispanic White) are significant in our results, identifying as the potential moderators of the effect of behavioral treatment. This suggests that participants receiving the BASC treatment with an income level of \$35,001–50,000 or identifying as Non-Hispanic White may experience an additional increase in their odds of smoking cessation. Conversely, exclusive mentholated cigarette users undergoing the BASC treatment might experience an additional decrease in their odds of abstinence.

The model also has several interaction terms with the indicator of varenicline treatment which identify potential moderators for the pharmacological treatment on the EOT abstinence for people with MDD. Specifically, age, cigarette reward value (`crv_total_pq1`), education level (high school graduate or GED), race (Hispanic & Mixed Race), and sex serve as potential moderators. These interactions suggest that the effectiveness of varenicline may vary depending on these baseline characteristics, highlighting the nuanced ipact of pharmacological treatment across different demographic and behavioral profiles.

```{r}
bootstrap_summary <- read.csv("Bootstrap_Results/summary_results.csv")
bootstrap_summary %>% 
  kable(booktabs = TRUE, caption = "Bootstrap Lasso Model Coefficient Estimate ") %>%
  kable_styling(font_size = 7, latex_options = c("repeat_header", "HOLD_position", "scale_down"))
```

In comparison, the bootstrapped coefficient results in `Table 6` provide additional insights into predictor stability. Variables like hedonsum_n_pq1 and readiness, which exhibited limited significance in the original analysis, are dropped from the bootstrapped results, reflecting their minimal contribution. Conversely, new significant interactions emerge, such as between behavioral treatment and Anhedonia(`shaps_score_pq1`) and the indicator of whether taking antidepressant medication (`antidepmed`), both showing positive coefficient estimates. The previously observed significant interaction between behavioral treatment and sex is no longer present. Additionally, most variables exhibit confidence intervals that do not contain zero, suggesting they consistently demonstrate an effect across bootstrap iterations. However, the interaction term between varenicline and the race variable has a confidence interval that includes zero, indicating that its effect may not be as robust or consistent as the others.

```{r, out.width = "80%", fig.align = "center", fig.height = 3}
# Read in the bootstrap ROC
bootstrap_roc_image <- image_read("BootStrap_Results/roc_curve.png")
bootstrap_roc_image
```

```{r, out.width = "90%", fig.height = 3, fig.align = "center"}
# Read in the bootstrap calibration
bootstrap_calibration_image <- image_read("BootStrap_Results/calibration_plot.png")
bootstrap_calibration_image
```
We performed model evaluation using the ROC and calibration plots across the bootstrapped training and testing sets, as presented in `Figure 8` and `Figure 9`. The train AUC is 0.814, and the test AUC is 0.807, indicating strong predictive performance of the model. The close proximity of these AUC values between the train and test sets demonstrates that the model generalizes well, as it exhibits similar performance on both datasets. Moreover, the calibration curves in both sets generally align with the ideal line, with some deviations at higher predicted probabilities. There is no significant differences in calibration are observed between the training and testing sets, further supporting the model's robustness and reliability.

# Discussion

Collaborating with the study of smoking cessation for people with MDD led by Dr. George Papandonatos, this study aims to further investigate potential moderators of behavioral treatment (BASC vs. ST) on the EOT abstinence for this group of people and dedicates to identify baseline characteristics as predictors of abstinence, controlling for behavioral and pharmacotherapy treatment. Lasso regression is chosen to perform variable selection that helps to focus on the most influential baseline characteristics and their interaction terms, balancing predictivity with interpretability. In addition, we perform a bootstrap approach aiming to provide a more robust and reliable analysis.

Control for treatment and other factors, as predictors, higher nicotine dependence (higher FTCD score), higher and current MDD status both associate with lower likelihood of abstinence. Conversely, having faster nicotine metabolism (higher NMR in log scale) and identifying as Non-Hispanic White were associated with higher odds of abstinence, adjusting for treatment and other factors.

Additionally, FTCD score emerged as both a predictor and moderator, with participants with higher nicotine dependence score showing lower odds of abstinence and experiencing an additional reduce from BASC. Menthol cigarette use and income level also moderated the effects of BASC, with menthol users experiencing lower abstinence odds and individuals with incomes more than \$70,000 benefiting more from BASC. Furthermore, significant interaction terms with varenicline suggest that the efficacy of pharmacotherapy varies by factors like cigarette reward value, education, race, and age. The model evaluation using ROC and calibration plots reveals our model's strong discriminative power and exhibits well-calibrated results.

As noted in the original paper, a limitation of this study is the low adherence to both behavioral treatment and pharmacotherapy, particular in the BASC-only group. The use of an ITT approach under this scenario might lead to an underestimation of treatment effects due to low adherence. An additional limitation of our analysis is that, although our sample provides a diverse phase of patients with MDD, certain levels within some categorical variables have limited sample sizes. For example, as shown in `Table 3`, only one observation falls within the "Grade school" category for education. This limited representation may reduce the statistical power and limit the generalizability of our study. 

Further research could explore strategies to enhance engagement and adherence and expand data collection to achieve more balanced representation of those underrepresented groups to improve the accuracy and generalizability of our model. Additionally, a future direction would be to apply a multilevel modeling approach which allows for the analysis of time-varying and group-level predictors, such as provider expertise or site-specific support. This method would allow us to assess how these factors interact with individual characteristics to impact abstinence outcome. Moreover, due to computational limitation and convergence issue, our analysis only focused on Lasso regression and we performed the bootstrap approach with only 200 iterations. Further researches using relaxed lasso or L0 + L2 penalty with more bootstrap iterations are recommended.

\newpage

```{r ref.label = knitr::all_labels()}
#| echo: true
#| eval: false
```

# Reference